<!DOCTYPE html>
<html>

<head>
    <title>device admin page</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        table th {
            text-align: left;
        }

        .itemRow {
            padding: 0px;
            margin: 0px;
        }
    </style>
</head>

<body class="m-2 bg-neutral-950 text-white p-1">
    <a href="/api/login">login</a><br>

    <span id="userTableMeta"></span>
    <table id="userTable" class="table-fixed w-full bg-neutral-900 mb-3">
        <thead class="border-solid border-gray-300 border-b-2">
            <tr>
                <th class="w-64 px-2 py-1 text-left">User</th>
                <th class="w-64 px-2 py-1 text-left">Google Id</th>
                <th class="px-2 py-1 text-left">Default question</th>
                <th class="w-20 px-2 py-1 text-left">Role</th>
                <th class="w-32 px-2 py-1 text-left">Joined at</th>
            </tr>
        </thead>
    </table>

    <span id="deviceTableMeta"></span>
    <table id="deviceTable" class="table-fixed w-full bg-neutral-900">
        <thead class="border-solid border-gray-300 border-b-2">
            <th class="px-2 py-1 text-left">Device</th>
            <th class="px-2 py-1 text-left">Current session</th>
            <th class="w-24 px-2 py-1 text-left">Last seen</th>
            <th class="w-24 px-2 py-1 text-left">Lastest login</th>
            <th class="w-24 px-2 py-1 text-left">Registrated at</th>
        </thead>
    </table>
    <script type="module">
        const API_URL = "/api";

        const userTable = document.getElementById("userTable");
        const userTableMeta = document.getElementById("userTableMeta");
        const deviceTable = document.getElementById("deviceTable");
        const deviceTableMeta = document.getElementById("deviceTableMeta");

        (async function () {
            const res = await fetch(API_URL + "/user", {
                method: "GET"
            });
            let body = await res.json();
            console.log(body);
            let users = body.data
            console.log("users", users);

            const updated = new Date(body.timestamp)
            const date = updated.toISOString().slice(0, 10)
            const time = updated.toISOString().slice(11, 16)
            const isToday = date == new Date().toISOString().slice(0, 10)
            userTableMeta.innerText = `${time} ${isToday ? "today" : date}`

            for (let i = 0; i < users.length; i++) {
                const user = users[i]
                let row = document.createElement("tr")
                row.classList.add("itemRow")

                let nameData = document.createElement("td")

                let usernameSpan = document.createElement("span")
                usernameSpan.classList.add("font-semibold")
                usernameSpan.innerText = user.display_name
                nameData.appendChild(usernameSpan)

                nameData.appendChild(document.createElement("br"))

                let emailSpan = document.createElement("span")
                emailSpan.innerText = user.email
                nameData.appendChild(emailSpan)

                row.appendChild(nameData)

                let googleIdData = document.createElement("td")
                googleIdData.innerText = user.google_sub
                row.appendChild(googleIdData)

                let defaultQuestionData = document.createElement("td")
                defaultQuestionData.classList.add(
                    "text-nowrap",
                    "truncate",
                    "max-w-1"
                )
                defaultQuestionData.innerText = user.default_question
                defaultQuestionData.title = user.default_question
                row.appendChild(defaultQuestionData)


                let roleData = document.createElement("td")
                roleData.innerText = user.role
                row.appendChild(roleData)

                let joinedAtData = document.createElement("td")
                const joinedAt = new Date(user.joinedAt)
                const formattedDate = joinedAt.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                joinedAtData.innerText = formattedDate
                row.appendChild(joinedAtData)

                userTable.appendChild(row)
            }
        })();


        (async function () {
            const res = await fetch(API_URL + "/device", {
                method: "GET"
            });
            let body = await res.json();
            console.log(body);
            let devices = body.data
            console.log("devices", devices);

            const updated = new Date(body.timestamp)
            const date = updated.toISOString().slice(0, 10)
            const time = updated.toISOString().slice(11, 16)
            const isToday = date == new Date().toISOString().slice(0, 10)
            deviceTableMeta.innerText = `${time} ${isToday ? "today" : date}`

            for (let i = 0; i < devices.length; i++) {
                const device = devices[i]
                let row = document.createElement("tr")
                row.classList.add("itemRow")

                let nameData = document.createElement("td")

                let roomSpan = document.createElement("span")
                roomSpan.classList.add("font-semibold")
                if (device.room) {
                    roomSpan.innerText = device.room
                } else {
                    roomSpan.innerText = "No room set"
                    roomSpan.classList.add("italic")
                }
                nameData.appendChild(roomSpan)

                nameData.appendChild(document.createElement("br"))

                let idSpan = document.createElement("span")
                idSpan.innerText = `Id:${device.id}`
                nameData.appendChild(idSpan)

                row.appendChild(nameData)

                let sessionData = document.createElement("td")
                if (device.active_session_id) {
                    const sessionId = device.active_session_id
                    const sessionRes = await fetch(API_URL + "/session/" + sessionId, {
                        method: "GET"
                    });
                    let sessionBody = await sessionRes.json();
                    console.log(sessionBody);
                    let sessionInfo = sessionBody.data
                    console.log("sessions", sessionInfo);

                    sessionData.innerText = sessionInfo.question
                } else {
                    sessionData.innerText = "none"
                    sessionData.classList.add("italic", "text-gray-100")
                }
                row.appendChild(sessionData)

                let lastSeenData = document.createElement("td")
                const lastSeen = new Date(device.last_seen)
                lastSeenData.innerText = lastSeen.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                row.appendChild(lastSeenData)

                let latestLoginData = document.createElement("td")
                const latestLogin = new Date(device.latest_login)
                latestLoginData.innerText = lastSeen.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                row.appendChild(latestLoginData)

                let registeredAtData = document.createElement("td")
                const registeredAt = new Date(device.last_seen)
                registeredAtData.innerText = lastSeen.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                row.appendChild(registeredAtData)

                deviceTable.appendChild(row)
            }
        })();

    </script>
</body>

</html>