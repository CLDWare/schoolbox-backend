<!DOCTYPE html>
<html>

<head>
    <title>dev device</title>
    <style>
        .statusBar {
            height: 5vh;
        }

        #connectionStatus::before {
            content: '';
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 7.5px;
            background-color: red;
            margin-right: 5px;
        }

        #connectionStatus.connected::before {
            background-color: lawngreen;
        }

        .wsLog {
            height: 55vh;
            background: rgb(229, 229, 229);
            border: 5px solid rgb(211, 211, 211);
            border-radius: 15px;
            overflow: scroll;
        }

        .wsLog>div {
            border-bottom: 1px solid rgb(200, 200, 200);
            padding: 5px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .timestamp {
            color: gray;
            margin-right: .25em;
        }


        .server,
        .device {
            display: inline-block;
            width: 3em;
        }

        .server {
            color: chocolate;
        }

        .device {
            color: cornflowerblue;
        }

        .autoMsg {
            color: white;
            background-color: plum;
            padding: 4px;
            border-radius: 15px;
            margin-left: auto;
        }

        .deviceData {
            height: 9.5vh;
            margin-top: .5vh;
            background: rgb(229, 229, 229);
            border: 5px solid rgb(211, 211, 211);
            border-radius: 15px;
            overflow: scroll;
        }

        .deviceData>span {
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div id="statusBar" class="statusBar">
        <span id="connectionStatus"></span>
    </div>
    <div id="wsLog" class="wsLog"></div>
    <div id="deviceData" class="deviceData"></div>
    <div id="startFlowDiv">
        <select id="flowSelect">
            <option value="registrationFlow">Registration</option>
            <option value="authenticationFlow">Authentication</option>
        </select>
        <button id="startFlowBtn">Start flow</button>
    </div>
    <div id="registrationFlowDiv" style="display: none;">
        <p>Registration pin: <span id="registrationPin"></span></p>
    </div>
    <div id="authenticationFlowDiv" style="display: none;">
        <p>Authentication nonce: <span id="authenticationNonce"></span></p><br>
        <input id="authenticationId" placeholder="device id">
        <button id="authenticationStart">Start authenticating</button><br>
        <input id="authenticationToken" placeholder="token">
        <button id="authenticationSubmit">Authenticate</button>
    </div>
    <script>
        const API_URL = "http://localhost:8080";
        let autoPong = true;

        let deviceData = {};
        const deviceDataDiv = document.getElementById("deviceData");
        function updateDeviceData(key, value) {
            deviceData[key] = value;
            console.log(deviceData)

            deviceDataDiv.innerHTML = "";
            for (const key in deviceData) {
                if (!Object.hasOwn(deviceData, key)) continue;
                const value = deviceData[key];

                const span = document.createElement("span");
                span.innerText = `${key}: ${value}`;
                deviceDataDiv.appendChild(span);
                deviceDataDiv.appendChild(document.createElement("br"));
            }
        };

        const ws = new WebSocket(API_URL + "/ws");

        const connectionStatusSpan = document.getElementById("connectionStatus");
        ws.addEventListener("open", () => {
            console.log("Websocket connection established", ws);

            connectionStatusSpan.innerText = "Connected";
            connectionStatusSpan.classList.add("connected");
        });
        ws.addEventListener("close", () => {
            console.log("Websocket connection closed", ws);

            connectionStatusSpan.innerText = "Disconnected"
            connectionStatusSpan.classList.remove("connected")
        });
        const wsLogDiv = document.getElementById("wsLog");

        function sendMessage(data, auto) {
            const div = document.createElement("div");

            const timestamp = document.createElement("span");
            datetext = new Date(Date.now()).toTimeString().split(' ')[0];
            timestamp.innerText = `[${datetext}]`;
            timestamp.classList.add("timestamp");
            div.appendChild(timestamp);

            const type = document.createElement("span");
            type.innerText = "device";
            type.classList.add("device");
            div.appendChild(type);

            const message = document.createElement("span");
            message.innerText = data;
            div.appendChild(message);

            if (auto) {
                const autoSpan = document.createElement("span");
                autoSpan.innerText = "auto";
                autoSpan.classList.add("autoMsg");
                div.appendChild(autoSpan);
            }

            wsLogDiv.appendChild(div);
            return ws.send(data);
        }

        let handleWsMessage = (data) => { }
        ws.addEventListener("message", (event) => {
            console.log("Websocket message recieved:", event.data);
            const div = document.createElement("div");

            const timestamp = document.createElement("span");
            datetext = new Date(Date.now()).toTimeString().split(' ')[0];
            timestamp.innerText = `[${datetext}]`;
            timestamp.classList.add("timestamp");
            div.appendChild(timestamp);

            const type = document.createElement("span");
            type.innerText = "server";
            type.classList.add("server");
            div.appendChild(type);

            const message = document.createElement("span");
            message.innerText = event.data;
            div.appendChild(message);

            wsLogDiv.appendChild(div);

            let data = JSON.parse(event.data)

            if (data.c == "ping") {
                if (autoPong) {
                    sendMessage(JSON.stringify({ "c": "pong" }), true)
                }
            } else {
                if (handleWsMessage) {
                    handleWsMessage(data)
                }
            };
        });

        let stateFlows = {};

        const registrationFlowDiv = document.getElementById("registrationFlowDiv");
        const registrationPinSpan = document.getElementById("registrationPin");
        const deviceIdSpan = document.getElementById("deviceId");
        const deviceTokenSpan = document.getElementById("deviceToken")
        function handleRegistrationMessages(data) {
            if (data.c == "reg_pin") {
                registrationPinSpan.innerText = data.d.pin
            } else if (data.c == "reg_ok") {
                updateDeviceData("deviceId", data.d.id);
                updateDeviceData("deviceToken", data.d.token);
                registrationFlowDiv.style.display = "none";
                startFlowDiv.style.display = "inherit";
            }
        }
        stateFlows.registrationFlow = async () => {
            registrationFlowDiv.style.display = "inherit";
            handleWsMessage = handleRegistrationMessages;

            sendMessage(JSON.stringify({ "c": "reg_start" }));
        };

        const authenticationFlowDiv = document.getElementById("authenticationFlowDiv");
        const authenticationNonceSpan = document.getElementById("authenticationNonce");
        const authenticationIdInput = document.getElementById("authenticationId");
        const authenticationStartButton = document.getElementById("authenticationStart");
        const authenticationTokenInput = document.getElementById("authenticationToken");
        const authenticationSubmitButton = document.getElementById("authenticationSubmit");
        authenticationStartButton.addEventListener("click", (event) => {
            sendMessage(JSON.stringify({
                "c": "auth_start",
                "d": {
                    "id": +authenticationIdInput.value
                }
            }));
        });
        function toHex(data) {
            return Array.from(data).map((b) => b.toString(16)).join("");
        }
        async function generateHMAC(key, message) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            const messageData = encoder.encode(message);

            const cryptoKey = await crypto.subtle.importKey(
                "raw",
                keyData,
                {name: "HMAC", hash: {name: "SHA-256"}},
                false,
                ["sign"],
            );

            const signature = await crypto.subtle.sign(
                "HMAC",
                cryptoKey,
                messageData,
            );
            
            return toHex(new Uint8Array(signature));
        }
        authenticationSubmitButton.addEventListener("click", async (event) => {
            const nonce = authenticationNonceSpan.innerText;
            const token = authenticationTokenInput.value;

            const signature = await generateHMAC(token, nonce);
            sendMessage(JSON.stringify({
                "c":"auth_validate",
                "d": {
                    "signature": signature
                }
            }));
        });
        function handleAuthenticationMessages(data) {
            if (data.c == "auth_nonce") {
                authenticationNonceSpan.innerText = data.d.nonce
            } else if (data.c == "auth_ok") {
                updateDeviceData("auth", true);
                authenticationFlowDiv.style.display = "none";
                startFlowDiv.style.display = "inherit";
            }
        }
        stateFlows.authenticationFlow = async () => {
            authenticationFlowDiv.style.display = "inherit";
            handleWsMessage = handleAuthenticationMessages;

            authenticationIdInput.value = deviceData.deviceId || ""
            authenticationTokenInput.value = deviceData.deviceToken || ""
        };

        const startFlowDiv = document.getElementById("startFlowDiv");
        const flowSelect = document.getElementById("flowSelect");
        const startFlowBtn = document.getElementById("startFlowBtn");
        startFlowBtn.addEventListener("click", (e) => {
            startFlowDiv.style.display = "none";
            stateFlows[flowSelect.options[flowSelect.selectedIndex].value]();
        });
    </script>
</body>

</html>